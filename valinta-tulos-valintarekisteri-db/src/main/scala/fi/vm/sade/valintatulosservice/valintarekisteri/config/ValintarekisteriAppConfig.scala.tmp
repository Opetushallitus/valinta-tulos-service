package fi.vm.sade.valintatulosservice.valintarekisteri.config

import java.net.URL

import fi.vm.sade.utils.config.{ApplicationSettingsLoader, ConfigTemplateProcessor}
import fi.vm.sade.utils.slf4j.Logging
import fi.vm.sade.utils.tcp.PortFromSystemPropertyOrFindFree

object ValintarekisteriAppConfig extends Logging {
  implicit val settingsParser = ValintarekisteriSettingsParser



  //private implicit val settingsParser = ValintarekisteriSettingsParser
  //private val itPostgresPortChooser = new PortFromSystemPropertyOrFindFree("valintatulos.it.postgres.port")

  /**
    *  IT (integration test) profiles. Uses embedded mongo and PostgreSQL databases, and stubbed external deps
    */
  class IT extends EmbeddedPostgres with ValintarekisteriAppConfig {
    /*private lazy val itPostgres = new ITPostgres(itPostgresPortChooser)

    override def start {

      itPostgres.start()
    }

    override lazy val settings = loadSettings
      .withOverride(("valinta-tulos-service.valintarekisteri.ensikertalaisuus.max.henkilo.oids", "100"))
      .withOverride("valinta-tulos-service.valintarekisteri.db.url", s"jdbc:postgresql://localhost:${itPostgresPortChooser.chosenPort}/valintarekisteri")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.user")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.password")*/
  }

  trait ValintarekisteriAppConfig extends AppConfig {
    override implicit val settingsParser = ValintarekisteriSettingsParser
    override def settings:ValintarekisteriSettings
  }

  /*trait TemplatedProps extends AppConfig with LoadTemplatedProps {
    logger.info("Using template variables from " + templateAttributesURL)
    lazy val settings = loadSettings[ValintarekisteriSettings]
    /*def loadSettings = ConfigTemplateProcessor.createSettings(
      getClass.getResource("/oph-configuration/valinta-tulos-service-devtest.properties.template"),
      templateAttributesURL
    )*/
    //def templateAttributesURL: URL
  }*/

  trait EmbeddedPostgres extends ExampleTemplatedProps {
    private val itPostgresPortChooser = new PortFromSystemPropertyOrFindFree("valintatulos.it.postgres.port")
    private lazy val itPostgres = new ITPostgres(itPostgresPortChooser)

    override def start {
      itPostgres.start()
    }

    override lazy val settings = loadSettings
      .withOverride(("valinta-tulos-service.valintarekisteri.ensikertalaisuus.max.henkilo.oids", "100"))
      .withOverride("valinta-tulos-service.valintarekisteri.db.url", s"jdbc:postgresql://localhost:${itPostgresPortChooser.chosenPort}/valintarekisteri")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.user")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.password")
  }

  trait ExternalProps {
    def configFile = System.getProperty("user.home") + "/oph-configuration/valinta-tulos-service.properties"
    lazy val settings = ApplicationSettingsLoader.loadSettings(configFile)
  }

  trait ExampleTemplatedProps extends ValintarekisteriAppConfig with TemplatedProps {
    def templateAttributesURL = getClass.getResource("/oph-configuration/dev-vars.yml")
  }

  trait TemplatedProps {
    logger.info("Using template variables from " + templateAttributesURL)
    lazy val settings = loadSettings
    def loadSettings = ConfigTemplateProcessor.createSettings(
      getClass.getResource("/oph-configuration/valinta-tulos-service-devtest.properties.template"),
      templateAttributesURL
    )
    def templateAttributesURL: URL
  }
}


/*trait ValintarekisteriAppConfig extends AppConfig {
  private implicit val settingsParser = ValintarekisteriSettingsParser
}

object ValintarekisteriAppConfig extends AppConfig {
  //private implicit val settingsParser = ValintarekisteriSettingsParser
  //private val itPostgresPortChooser = new PortFromSystemPropertyOrFindFree("valintatulos.it.postgres.port")

  /**
    *  IT (integration test) profiles. Uses embedded mongo and PostgreSQL databases, and stubbed external deps
    */
  class IT extends AppConfig#EmbeddedPostgres {
    /*private lazy val itPostgres = new ITPostgres(itPostgresPortChooser)

    override def start {

      itPostgres.start()
    }

    override lazy val settings = loadSettings
      .withOverride(("valinta-tulos-service.valintarekisteri.ensikertalaisuus.max.henkilo.oids", "100"))
      .withOverride("valinta-tulos-service.valintarekisteri.db.url", s"jdbc:postgresql://localhost:${itPostgresPortChooser.chosenPort}/valintarekisteri")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.user")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.password")*/
  }
}*/

/*
object AppConfigProps extends Logging {
  private implicit val settingsParser = ValintarekisteriSettingsParser
  private val itPostgresPortChooser = new PortFromSystemPropertyOrFindFree("valintatulos.it.postgres.port")

  /**
   *  IT (integration test) profiles. Uses embedded mongo and PostgreSQL databases, and stubbed external deps
   */
  class IT extends ExampleTemplatedProps {
    private lazy val itPostgres = new ITPostgres(itPostgresPortChooser)

    override def start {

      itPostgres.start()
    }

    override lazy val settings = loadSettings
      .withOverride(("valinta-tulos-service.valintarekisteri.ensikertalaisuus.max.henkilo.oids", "100"))
      .withOverride("valinta-tulos-service.valintarekisteri.db.url", s"jdbc:postgresql://localhost:${itPostgresPortChooser.chosenPort}/valintarekisteri")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.user")
      .withoutPath("valinta-tulos-service.valintarekisteri.db.password")
  }

  trait ExternalProps {
    def configFile = System.getProperty("user.home") + "/oph-configuration/valinta-tulos-service.properties"
    lazy val settings = ApplicationSettingsLoader.loadSettings(configFile)
  }

  trait ExampleTemplatedProps extends AppConfig with TemplatedProps {
    def templateAttributesURL = getClass.getResource("/oph-configuration/dev-vars.yml")
  }

  trait TemplatedProps {
    logger.info("Using template variables from " + templateAttributesURL)
    lazy val settings = loadSettings
    def loadSettings = ConfigTemplateProcessor.createSettings(
      getClass.getResource("/oph-configuration/valinta-tulos-service-devtest.properties.template"),
      templateAttributesURL
    )
    def templateAttributesURL: URL
  }

  /*trait AppConfig {

    def start {}

    def settings: ApplicationSettings

    def properties: Map[String, String] = settings.toProperties

  }*/
}
 */

