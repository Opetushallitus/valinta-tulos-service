<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script type="application/javascript">
      function handleResponse(response) {
        hideAjaxIndicator();
        if (!response.text) {
          console.error('Kutsu palautti virheen', response);
          document.getElementById('response').innerHTML = 'Virhe palvelimelta: ' + response;
          return;
        }
        return response.text();
      }

      function displayHakuListResponse(responseText) {
        var list = document.getElementById('haku-list');
        var parsedResponse = JSON.parse(responseText);
        parsedResponse.forEach(function(row) {
          var rowElement = document.createElement("li");
          rowElement.onclick = function() {
            if (rowElement.childElementCount === 0) {
              loadHakukohdeSpecificDataFor(row.hakuOid, rowElement);
            } else {
              rowElement.removeChild(rowElement.getElementsByTagName('ul')[0]);
            }
          };
          rowElement.appendChild(document.createTextNode(JSON.stringify(row)));
          list.appendChild(rowElement);
        });
        showStatus('Hakujen tiedot ladattu ' + new Date());
      }

      function loadHakuList() {
        showStatus('Ladataan kaikkien hakujen tiedot...');
        var url = '/valinta-tulos-service/auth/puuttuvat/yhteenveto';
        console.log('About to get from URL ' + url);
        showAjaxIndicator();
        fetch(url, { method: 'get'})
          .then(handleResponse)
          .then(displayHakuListResponse)
          .catch(handleResponse);
        fetch('/valinta-tulos-service/auth/puuttuvat/taustapaivityksenTila')
          .then(handleResponse)
          .then(function (responseText) {
            displayBackgroundUpdateStatus(JSON.parse(responseText));
          })
          .catch(handleResponse)
      }

      function updateMissingResultsForAllHakus() {
        var paivitaMyosOlemassaolevat = document.getElementById("paivitaMyosOlemassaolevat").checked;
        var request = {
          method: 'post',
          body: JSON.stringify({paivitaMyosOlemassaolevat: paivitaMyosOlemassaolevat}),
          headers: new Headers({'Content-Type': 'application/json'})
        };
        var statusSuffix = paivitaMyosOlemassaolevat ? ' tietojen päivitys puuttuvista tuloksista kaikille hauille.' :
                  ' tietojen päivitys puuttuvista tuloksista hauille, joille ei vielä löydy tietoa puuttuvista.';
        showStatus('Käynnistetään' + statusSuffix + '..');
        showAjaxIndicator();
        fetch('/valinta-tulos-service/auth/puuttuvat/paivitaKaikki', request)
          .then(handleResponse)
          .then(function(responseText) {
            var taustapaivityksenTila = JSON.parse(responseText);
            displayBackgroundUpdateStatus(taustapaivityksenTila);
            if (taustapaivityksenTila.kaynnistettiin) {
              showStatus('Käynnistettiin' + statusSuffix);
            } else {
              showStatus('Ei käynnistetty taustapäivitystä, koska se on jo käynnistetty ' + taustapaivityksenTila.kaynnistetty +
                ' ' + taustapaivityksenTila.hakujenMaara + ' haulle.');
            }
          })
          .catch(handleResponse);
      }

      function displaySingleHakuResponse(hakuRowElement) {
        return function(responseText) {
          var parsedResponse = JSON.parse(responseText);
          var tarjoajaList = document.createElement("ul");
          hakuRowElement.appendChild(tarjoajaList);
          parsedResponse.forEach(function(tarjoajaRow) {
            tarjoajaList.appendChild(createTarjoajaElement(tarjoajaRow));
          });
        }
      }

      function createTarjoajaElement(tarjoajaRow) {
        var tarjoajaElement = document.createElement("li");
        tarjoajaElement.appendChild(document.createTextNode(tarjoajaRow.tarjoajanNimi + " (" + tarjoajaRow.tarjoajaOid + ")"));
        var hakukohdeList = document.createElement("ul");
        tarjoajaRow.puuttuvatTulokset.forEach(function (hakukohdeRow) {
          var hakukohdeElement = document.createElement("li");
          var linkToSijoittelunTuloksetElement = document.createElement("a");
          linkToSijoittelunTuloksetElement.onclick = function (e) {
            e.stopPropagation();
          };
          var puuttuvaTulosText = hakukohdeRow.puuttuvienMaara === 1 ?
            "1 puuttuva tulos" : hakukohdeRow.puuttuvienMaara + " puuttuvaa tulosta";
          linkToSijoittelunTuloksetElement.appendChild(document.createTextNode(hakukohdeRow.kohteenNimi +
            " (" + hakukohdeRow.hakukohdeOid + "), " + puuttuvaTulosText));
          linkToSijoittelunTuloksetElement.href = hakukohdeRow.kohteenValintaUiUrl;
          hakukohdeElement.appendChild(linkToSijoittelunTuloksetElement);
          hakukohdeList.appendChild(hakukohdeElement);
        });
        tarjoajaElement.appendChild(hakukohdeList);
        return tarjoajaElement;
      }

      function loadHakukohdeSpecificDataFor(hakuOid, hakuRowElement) {
        showAjaxIndicator();
        fetch('/valinta-tulos-service/auth/puuttuvat/haku/' + hakuOid, { method: 'get' })
          .then(handleResponse)
          .then(displaySingleHakuResponse(hakuRowElement))
          .catch(handleResponse);
      }

      function displayBackgroundUpdateStatus(taustapaivityksenTila) {
        var finished = taustapaivityksenTila.valmistui;
        var statusBeginning = taustapaivityksenTila.kaynnistetty ?
            'Viimeisin päivitys ' + taustapaivityksenTila.hakujenMaara + ' haulle on käynnistetty ' + taustapaivityksenTila.kaynnistetty :
            'Päivitystä ei ole käynnistetty';
        var statusText = statusBeginning + (finished ? ' ja valmistui ' + finished : '');
        document.getElementById('latestBackgroundUpdateStatus').innerText = statusText;
      }

      function showAjaxIndicator() {
        document.getElementById('ajaxIndicator').style.visibility = 'visible';
      }
      function hideAjaxIndicator() {
        document.getElementById('ajaxIndicator').style.visibility = 'hidden';
      }

      function showStatus(text) {
        document.getElementById('statusLine').innerText = text;
      }
    </script>
</head>
<body onload="loadHakuList();">
<div>
    <h3>Tiedot puuttuvista tuloksista hauittain <img id="ajaxIndicator" src="ajax-loader.gif" style="position: absolute; margin: 0; visibility: hidden"/></h3>
    <div>
        <span id="latestBackgroundUpdateStatus"/>
    </div>
    <div>
        <span id="statusLine"/>
    </div>
    <div>
        <button onclick="updateMissingResultsForAllHakus()">Hae tiedot puuttuvista tuloksista kaikille hauille</button> (tässä voi kestää)
        <p>
            <input type="checkbox" id="paivitaMyosOlemassaolevat"/>Päivitä tiedot myös hauille, joilta tiedot jo löytyvät
        </p>
    </div>
    <ul id="haku-list">
    </ul>
</div>
</body>
</html>
