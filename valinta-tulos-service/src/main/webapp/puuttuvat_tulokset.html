<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script type="application/javascript">
      function handleResponse(response) {
        //document.getElementById('ajaxIndicator').style.visibility = 'hidden';
        if (!response.text) {
          console.error('Kutsu palautti virheen', response);
          document.getElementById('response').innerHTML = 'Virhe palvelimelta: ' + response;
          return;
        }
        return response.text();
      }

      function displayHakuListResponse(responseText) {
        var list = document.getElementById('haku-list');
        var parsedResponse = JSON.parse(responseText);
        parsedResponse.forEach(function(row) {
          var rowElement = document.createElement("li");
          rowElement.onclick = function() { loadHakukohdeSpecificDataFor(row.hakuOid, rowElement) };
          rowElement.appendChild(document.createTextNode(JSON.stringify(row)));
          list.appendChild(rowElement);
        });
      }

      function loadHakuList() {
        var url = '/valinta-tulos-service/auth/puuttuvat/yhteenveto';
        console.log('About to get from URL ' + url);
        fetch(url, { method: 'get'})
          .then(handleResponse)
          .then(displayHakuListResponse)
          .catch(handleResponse);
      }

      function displaySingleHakuResponse(hakuRowElement) {
        return function(responseText) {
          var parsedResponse = JSON.parse(responseText);
          var tarjoajaList = document.createElement("ul");
          hakuRowElement.appendChild(tarjoajaList);
          parsedResponse.forEach(function(tarjoajaRow) {
            var tarjoajaElement = document.createElement("li");
            tarjoajaElement.appendChild(document.createTextNode(tarjoajaRow.tarjoajanNimi + " (" + tarjoajaRow.tarjoajaOid + ")"));
            var hakukohdeList = document.createElement("ul");
            tarjoajaRow.puuttuvatTulokset.forEach(function(hakukohdeRow) {
              var hakukohdeElement = document.createElement("li");
              var linkToSijoittelunTuloksetElement = document.createElement("a");
              var puuttuvaTulosText = hakukohdeRow.puuttuvienMaara === 1 ?
                "1 puuttuva tulos" : hakukohdeRow.puuttuvienMaara + " puuttuvaa tulosta";
              linkToSijoittelunTuloksetElement.appendChild(document.createTextNode(hakukohdeRow.kohteenNimi +
                " (" + hakukohdeRow.hakukohdeOid + "), " + puuttuvaTulosText));
              linkToSijoittelunTuloksetElement.href = hakukohdeRow.kohteenValintaUiUrl;
              hakukohdeElement.appendChild(linkToSijoittelunTuloksetElement);
              hakukohdeList.appendChild(hakukohdeElement);
            });
            tarjoajaElement.appendChild(hakukohdeList);
            tarjoajaList.appendChild(tarjoajaElement);
          });
        }
      }

      function loadHakukohdeSpecificDataFor(hakuOid, hakuRowElement) {
        fetch('/valinta-tulos-service/auth/puuttuvat/haku/' + hakuOid, { method: 'get' })
          .then(handleResponse)
          .then(displaySingleHakuResponse(hakuRowElement))
          .catch(handleResponse);
      }
    </script>
</head>
<body onload="loadHakuList();">
<div>
    <h3>Haut</h3>
    <ul id="haku-list">
    </ul>
</div>
</body>
</html>
